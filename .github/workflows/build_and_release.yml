name: Build and Release CTP Tools

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libxerces-c-dev libxml-security-c-dev autoconf automake libtool wget cmake

      - name: Build and Install OpenJPEG 1.5
        run: |
          wget http://downloads.sourceforge.net/project/openjpeg.mirror/1.5.2/openjpeg-1.5.2.tar.gz
          tar -xzvf openjpeg-1.5.2.tar.gz
          cd openjpeg-1.5.2
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
          make
          sudo make install
          sudo ldconfig
          # Copy headers required by j2c-scan
          cp libopenjpeg/openjpeg.h ../ctp_compliance_tests/tools/
          cp libopenjpeg/j2k.h ../ctp_compliance_tests/tools/
          cd ..

      - name: Build and Install asdcplib
        run: |
          git clone https://github.com/cinecert/asdcplib.git
          cd asdcplib
          autoreconf -if
          ./configure
          make
          sudo make install
          sudo ldconfig
          cd ..

      - name: Build Tools
        run: |
          cd ctp_compliance_tests/tools
          make

      - name: Package Linux Binaries
        run: |
          mkdir -p dist/linux
          cp ctp_compliance_tests/tools/dc-thumbprint dist/linux/
          cp ctp_compliance_tests/tools/schema-check dist/linux/
          cp ctp_compliance_tests/tools/kdm-decrypt dist/linux/
          cp ctp_compliance_tests/tools/j2c-scan dist/linux/
          cp ctp_compliance_tests/tools/*.py dist/linux/
          cd dist/linux && tar -czvf ../../dci-ctp-tools-linux.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dci-ctp-tools-linux.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install openssl xerces-c xml-security-c autoconf automake libtool wget cmake

      - name: Build and Install OpenJPEG 1.5
        run: |
          wget http://downloads.sourceforge.net/project/openjpeg.mirror/1.5.2/openjpeg-1.5.2.tar.gz
          tar -xzvf openjpeg-1.5.2.tar.gz
          cd openjpeg-1.5.2
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
          make
          sudo make install
          # Copy headers required by j2c-scan
          cp libopenjpeg/openjpeg.h ../ctp_compliance_tests/tools/
          cp libopenjpeg/j2k.h ../ctp_compliance_tests/tools/
          cd ..

      - name: Build and Install asdcplib
        run: |
          git clone https://github.com/cinecert/asdcplib.git
          cd asdcplib
          autoreconf -if
          ./configure --with-openssl=$(brew --prefix openssl)
          make
          sudo make install
          cd ..

      - name: Build Tools
        run: |
          cd ctp_compliance_tests/tools
          export CFLAGS="-I$(brew --prefix openssl)/include -I$(brew --prefix xerces-c)/include -I$(brew --prefix xml-security-c)/include"
          export CXXFLAGS="-I$(brew --prefix openssl)/include -I$(brew --prefix xerces-c)/include -I$(brew --prefix xml-security-c)/include"
          export LDFLAGS="-L$(brew --prefix openssl)/lib -L$(brew --prefix xerces-c)/lib -L$(brew --prefix xml-security-c)/lib"
          make

      - name: Package macOS Binaries
        run: |
          mkdir -p dist/macos
          cp ctp_compliance_tests/tools/dc-thumbprint dist/macos/
          cp ctp_compliance_tests/tools/schema-check dist/macos/
          cp ctp_compliance_tests/tools/kdm-decrypt dist/macos/
          cp ctp_compliance_tests/tools/j2c-scan dist/macos/
          cp ctp_compliance_tests/tools/*.py dist/macos/
          cd dist/macos && tar -czvf ../../dci-ctp-tools-macos.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: dci-ctp-tools-macos.tar.gz

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dci-ctp-tools-linux.tar.gz
            dci-ctp-tools-macos.tar.gz
