name: Generate DCP

on:
  push:
    branches:
      - main
    paths:
      - 'test_materials/**'
      - 'ctp_compliance_tests/tools/**'
      - '.github/workflows/generate_dcp.yml'
  workflow_dispatch:  # Allow manual trigger without inputs

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Discover Tests
        id: set-matrix
        run: |
          # Run discovery script and capture JSON output
          MATRIX_JSON=$(python3 ctp_compliance_tests/tools/discover_tests.py --dir test_materials)
          echo "Discovered tests: $MATRIX_JSON"
          # Set output for next job
          echo "matrix={\"include\":$MATRIX_JSON}" >> $GITHUB_OUTPUT

  generate-dcp:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libxerces-c-dev libxml-security-c-dev autoconf automake libtool wget cmake patchelf unzip

      - name: Build and Install OpenJPEG 1.5
        run: |
          wget http://downloads.sourceforge.net/project/openjpeg.mirror/1.5.2/openjpeg-1.5.2.tar.gz
          tar -xzvf openjpeg-1.5.2.tar.gz
          cd openjpeg-1.5.2
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          make
          sudo make install
          sudo ldconfig
          cd ..

      - name: Build and Install asdcplib
        run: |
          git clone https://github.com/cinecert/asdcplib.git
          cd asdcplib
          autoreconf -if
          ./configure
          make
          sudo make install
          sudo ldconfig
          cd ..

      - name: Generate DCP for ${{ matrix.name }}
        run: |
          # Get inputs from matrix
          INPUT_PATH="${{ matrix.input_path }}"
          CLEAN_NAME="${{ matrix.clean_name }}"
          FPS="${{ matrix.fps }}"
          
          echo "Processing: $CLEAN_NAME"
          echo "Input: $INPUT_PATH"
          
          # Generate Date
          DATE=$(date +%Y%m%d)
          
          # Construct Title
          # Structure: Title_ContentType_AspectRatio_Language_Territory_Rating_Audio_Resolution_Studio_Date_Facility_Standard_PackageType
          # We use values from matrix or defaults
          RES="${{ matrix.resolution }}"
          AR="${{ matrix.aspect_ratio }}"
          AUDIO="${{ matrix.audio }}"
          
          DCP_TITLE="${CLEAN_NAME}_TST_${AR}_XX-XX_INT-TD_${AUDIO}_${RES}_CTP_${DATE}_SMPTE_OV"
          
          echo "Generated Title: $DCP_TITLE"
          
          # Determine duration (default 120 frames = 5s @ 24fps)
          # If it's a sequence, the script handles duration automatically
          DURATION=120
          
          # Run generation script
          python3 ctp_compliance_tests/tools/generate_dcp.py \
            --image "$INPUT_PATH" \
            --output "dcp_output" \
            --duration $DURATION \
            --fps $FPS \
            --title "$DCP_TITLE"

      - name: Package DCP as ZIP
        run: |
          cd dcp_output
          zip -r ../DCP_${{ matrix.clean_name }}.zip .
          cd ..
          
      - name: Upload DCP ZIP as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dcp-${{ matrix.clean_name }}
          path: DCP_${{ matrix.clean_name }}.zip

  release:
    needs: generate-dcp
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all DCP artifacts
        uses: actions/download-artifact@v4
        with:
          path: dcp-releases
          
      - name: Prepare release files
        run: |
          mkdir -p release-files
          # Move all zip files to release-files directory
          find dcp-releases -name "*.zip" -exec mv {} release-files/ \;
          ls -lh release-files/
          
      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-dcps
          name: Latest DCP Packages
          body: |
            # Automated DCP Releases
            
            This release contains automatically generated DCP packages for all test materials.
            Each DCP is packaged as a separate ZIP file.
            
            **Generated:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
          files: release-files/*.zip
          fail_on_unmatched_files: false
          prerelease: false
          draft: false
