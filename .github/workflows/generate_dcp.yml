name: Generate DCP

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: 'Name of the test to generate DCP for'
        required: true
        default: '2K 2D 24 FPS Test'
      duration_frames:
        description: 'Duration in frames'
        required: true
        default: '24'

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Discover Tests
        id: set-matrix
        run: |
          # Run discovery script and capture JSON output
          MATRIX_JSON=$(python3 ctp_compliance_tests/tools/discover_tests.py --dir test_materials)
          echo "Discovered tests: $MATRIX_JSON"
          # Set output for next job
          echo "matrix={\"include\":$MATRIX_JSON}" >> $GITHUB_OUTPUT

  generate-dcp:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libxerces-c-dev libxml-security-c-dev autoconf automake libtool wget cmake patchelf unzip

      - name: Build and Install OpenJPEG 1.5
        run: |
          wget http://downloads.sourceforge.net/project/openjpeg.mirror/1.5.2/openjpeg-1.5.2.tar.gz
          tar -xzvf openjpeg-1.5.2.tar.gz
          cd openjpeg-1.5.2
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          make
          sudo make install
          sudo ldconfig
          cd ..

      - name: Build and Install asdcplib
        run: |
          git clone https://github.com/cinecert/asdcplib.git
          cd asdcplib
          autoreconf -if
          ./configure
          make
          sudo make install
          sudo ldconfig
          cd ..

      - name: Generate DCP for ${{ matrix.name }}
        run: |
          # Get inputs from matrix
          INPUT_PATH="${{ matrix.input_path }}"
          CLEAN_NAME="${{ matrix.clean_name }}"
          FPS="${{ matrix.fps }}"
          
          echo "Processing: $CLEAN_NAME"
          echo "Input: $INPUT_PATH"
          
          # Generate Date
          DATE=$(date +%Y%m%d)
          
          # Construct Title
          # Structure: Title_ContentType_AspectRatio_Language_Territory_Rating_Audio_Resolution_Studio_Date_Facility_Standard_PackageType
          # We use values from matrix or defaults
          RES="${{ matrix.resolution }}"
          AR="${{ matrix.aspect_ratio }}"
          AUDIO="${{ matrix.audio }}"
          
          DCP_TITLE="${CLEAN_NAME}_TST_${AR}_XX-XX_INT-TD_${AUDIO}_${RES}_CTP_${DATE}_SMPTE_OV"
          
          echo "Generated Title: $DCP_TITLE"
          
          # Determine duration (default 120 frames = 5s @ 24fps)
          # If it's a sequence, the script handles duration automatically
          DURATION=120
          
          # Run generation script
          python3 ctp_compliance_tests/tools/generate_dcp.py \
            --image "$INPUT_PATH" \
            --output "dcp_output" \
            --duration $DURATION \
            --fps $FPS \
            --title "$DCP_TITLE"

      - name: Upload DCP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dcp-${{ matrix.clean_name }}
          path: dcp_output/
